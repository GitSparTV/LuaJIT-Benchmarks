<html>
	<head>
		<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
		<title>LuaJIT Benchmark Tests</title>
		<meta name="description" content="LuaJIT Benchmark tests page. Made for understanding the results and for optimization solutions.">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="keywords" content="Lua, LuaJIT, benchmark, benchmark tests, performance, LuaJIT vs Lua, LuaJIT performance, Lua performance">
		<style type="text/css">
			body {
				font-family: 'Roboto', sans-serif;
				margin: 0;
			}
			#g {
				height: 20em;
				background-image: linear-gradient(#6078bf, white);
			}
			#bottom {
				height: 14em;
				width: 100%;
			}
			#header1 {
				padding-left: 1em; font-size: 3em; padding-top: 1em;
			}
			#text1 {
				padding-left: 4em; font-size: 1.2em; padding-top: 1em;
			}
			#code {
			    color: black;
			    background-color: #f9f9f9;
			    border: 1px solid #ddd;
				padding: 1em;
			    line-height: 1.1em;
			    margin-right: 50%;
			    margin-left: 1em;
				margin-top: 1em;
				margin-bottom: 1em;
			    font-size: 1em;
			    white-space: pre-wrap;
			}
			#inlcode {
				color: black;
			    background-color: #f9f9f9;
			    border: 1px solid #ddd;
			    border-radius: 2px;
			    padding: 1px 4px;
			}
			#highlight {
				font-weight: bold;
				text-decoration: underline;
				text-decoration-color: red;
			}
			#subh {
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<div id="g">
			<div style="text-align: center; font-size: 6em; padding-top: 2em">LuaJIT Benchmarks</div>
		</div>

		<div id="header1" style="padding-top: 3em;">About</div> <!-- ---------------------------------------------------- -->
		<div id="text1">These benchmark tests demonstrate the changes in LuaJIT performance against the Lua performance.<br>
						LuaJIT stated that globals and locals now has the same performance unlike in plain Lua,<br>
						LuaJIT uses its own VM and many other optimizations to improve the performance. But how was it changed from Lua?<br> 
						First 14 benchmark tests are taken from this page: <a href="https://springrts.com/wiki/Lua_Performance">https://springrts.com/wiki/Lua_Performance</a>.<br>
						New benchmark tests are welcome. <a href="https://github.com/GitSparTV/LuaJIT-Benchmarks/">GitHub Page</a><br>
						Specs: Intel i5-6500 3.20 GHz. 64-bit. LuaJIT 2.1.0-beta3.<br>
						(JIT: ON SSE2 SSE3 SSE4.1 BMI2 fold cse dce fwd dse narrow loop abc sink fuse)
		</div>

		<div id="header1">Benchmark Code</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<a href="https://github.com/GitSparTV/LuaJIT-Benchmarks/blob/master/bench.lua">Source code</a><br>
		Basically we will use this:<br>
		<div id="code">
for take = 1, 100 do
	local START = os.clock()

	for times = 1, 1000000 do
		...
	end

	local END = os.clock()
end
		</div>
	For percentage comparison we use the maximum of 100 takes. Average value may be more precise, so make sure to keep that in mind.</div>

		<div id="header1">1. Localized variable</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local s = math.sin
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
local x = math.sin(3.14)
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local x = s(3.14)
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. Global / _ENV variable: 0.001 (Min: 0, Average: 0.00033) second(s) (100%)<br>
			&nbsp;&nbsp;2. Localized variable: 0.001 (Min: 0, Average: 0.00032) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;No difference. (Fun fact: global variable in plain Lua takes <a id="highlight">0.7s</a>) 
		</div>

		<div id="header1">2. Localized method. (3 calls)</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local class = {
	test = function() return 1 end
}
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
local x = class.test()
local y = class.test()
local z = class.test()
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local test = class.test
local x = test()
local y = test()
local z = test()
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. Direct call: 0.001 (Min: 0, Average: 0.00031) second(s) (100%)<br>
			&nbsp;&nbsp;2. Localized method call: 0.001 (Min: 0, Average: 0.00033) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;No difference.
		</div>

		<div id="header1">3. Unpack</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local min = math.min
local unpack = unpack
local a = {100, 200, 300, 400}

local function unpack4(a)
	return a[1], a[2], a[3], a[4]
end
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
local x = min(a[1], a[2], a[3], a[4])
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local x = min(unpack(a))
			</div>
			<div id="subh">Code 3:</div>
			<div id="code">
local x = min(unpack4(a))
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. a[n]: 0.001 (Min: 0, Average: 0.00034) second(s) (100%)<br>
			&nbsp;&nbsp;2. <a id="highlight">unpack(a): 0.05 (Min: 0.044, Average: 0.04572) second(s) (5000%)</a><br>
			&nbsp;&nbsp;3. unpack4(a): 0.001 (Min: 0, Average: 0.00035) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;Don't use <a id="inlcode">unpack()</a> when performance matters. (Fun fact: Plain Lua unpack() scored <a id="highlight">1.093s (225%)</a>)
		</div>

		<div id="header1">4. Find and return maximum value</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local max = math.max
local num = 100
local y = 0
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
x = max(num, y)
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
if (num > y) then
	x = num
end
			</div>
			<div id="subh">Code 3:</div>
			<div id="code">
x = num > y and num or x
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. math.[max/min]: 0.001 (Min: 0, Average: 0.00032) second(s) (100%)<br>
			&nbsp;&nbsp;2. if [>/<] then: 0.001 (Min: 0, Average: 0.00035) second(s) (100%)<br>
			&nbsp;&nbsp;3. >/< and ... or ...: 0.001 (Min: 0, Average: 0.00034) second(s) (100%)

			<div id="subh">Conclusion:</div>
			&nbsp;Depends on situation, both are ok. (Fun fact: Plain Lua has the opposite results: max/min are twice slower than >/<)
		</div>

		<div id="header1">5. nil check (if vs a or b)</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Code 1:</div>
			<div id="code">
local y, x

if (y == nil) then
	x = 1
else
	x = y
end
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local y

local x = y or 1
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. if nil: 0.001 (Min: 0, Average: 0.00034) second(s) (100%)<br>
			&nbsp;&nbsp;2. a or b: 0.001 (Min: 0, Average: 0.00033) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;No difference. 
		</div>

		<div id="header1">6. x^2 vs x*x</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local x = 10
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
local y = x ^ 2
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local y = x * x
			</div>
			<div id="subh">Code 3:</div>
			<div id="code">
local y = math.pow(x,2)
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. x^2: 0.001 (Min: 0, Average: 0.00033) second(s) (100%)<br>
			&nbsp;&nbsp;2. x*x: 0.001 (Min: 0, Average: 0.00032) second(s) (100%)<br>
			&nbsp;&nbsp;3. math.pow: 0.001 (Min: 0, Average: 0.00032) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;No difference. (Fun fact: Plain Lua run x^2 in <a id="highlight">1.422s</a>)
		</div>

		<div id="header1">7. math.fmod vs % operator</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local fmod = math.fmod
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
local x = fmod(times, 30) < 1
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local x = (times % 30) < 1
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. <a id="highlight">math.fmod: 0.031 (Min: 0.025, Average: 0.02737) second(s) (620%)</a><br>
			&nbsp;&nbsp;2. % operator: 0.005 (Min: 0.003, Average: 0.00406) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;Use % for positive numbers.
		</div>

		<div id="header1">8. Predefined function or anonymous function in argument</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local func1 = function(a, b, func) return func(a + b) end
local func2 = function(a) return a * 2 end
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
local x = func1(1, 2, function(a) return a * 2 end)
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local x = func1(1, 2, func2)
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. <a id="highlight">Function in argument: 0.764 (Min: 0.536, Average: 0.58371) second(s) (76400%) </a><br>
			&nbsp;&nbsp;2. Localized function: 0.001 (Min: 0, Average: 0.00035) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;Anonymous function in argument is insensible in case of single use. Localize it in case of multiple use. (Fun fact: Plain Lua scored <a id="highlight">3.890s</a> with the first code)
		</div>

		<div id="header1">9. for loops</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local a = {}

for i = 1, 100 do
	a[#a + 1] = i
end
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
for k, v in pairs(a) do
	x = v
end
			</div>
			<div id="subh">Code 2 (Using <a href="https://github.com/LuaJIT/LuaJIT/pull/275">JIT-ed next</a>):</div>
			<div id="code">
for k, v in pairs(a) do
	x = v
end
			</div>
			<div id="subh">Code 3:</div>
			<div id="code">
for k, v in ipairs(a) do
	x = v
end
			</div>
			<div id="subh">Code 4:</div>
			<div id="code">
for i = 1, 100 do
	x = a[i]
end
			</div>
			<div id="subh">Code 5:</div>
			<div id="code">
for i = 1, #a do
	x = a[i]
end
			</div>
			<div id="subh">Code 6:</div>
			<div id="code">
local length = #a

for i = 1, length do
	x = a[i]
end
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. <a id="highlight">pairs(a): 1.03 (Min: 0.699, Average: 0.76613) second(s) (1170.45%)</a><br>
			&nbsp;&nbsp;2. pairs(a) with <a href="https://github.com/LuaJIT/LuaJIT/pull/275">JIT-ed next</a>: 0.873 (Min: 0.69, Average: 0.73745) second(s) (992.04%)<br>
			&nbsp;&nbsp;3. ipairs(a): 0.138 (Min: 0.112, Average: 0.11859) second(s) (156.81%)<br>
			&nbsp;&nbsp;4. Known length: 0.088 (Min: 0.077, Average: 0.08142) second(s) (100%)<br>
			&nbsp;&nbsp;5. #a: 0.135 (Min: 0.115, Average: 0.12182) second(s) (153.40%)<br>
			&nbsp;&nbsp;6. local len = #a: 0.13 (Min: 0.115, Average: 0.12153) second(s) (147.72%)
			<div id="subh">Conclusion:</div>

			&nbsp;&nbsp;Try to use array instead of hashtable. If you know the exact size, localize #a. Don't use pairs for sequential arrays.
		</div>
		<div id="header1">10. a[x] vs a.x</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local a = {
	foo = "bar"
}
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
x = a["foo"]
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
x = a.foo
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. a[x]: 0.001 (Min: 0, Average: 0.00034) second(s) (100%)<br>
			&nbsp;&nbsp;2. a.x: 0.001 (Min: 0, Average: 0.00033) second(s) (100%)
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;No difference.
		</div>

		<div id="header1">11. Localizing table value for multiple uses</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local a = {} for i=1,100 do a[#a + 1] = {x=10} end
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
for n = 1, 100 do
	a[n].x = a[n].x + 1
end
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
for n = 1, 100 do
	local y = a[n]
	y.x = y.x + 1
end
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. a[n] & a[n]: 0.187 (Min: 0.168, Average: 0.17429) second(s) (100%)<br>
			&nbsp;&nbsp;2. <a id="highlight">local y = a[n] & y & y: 0.215 (Min: 0.2, Average: 0.20592) second(s) (114.97%)</a>
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;Sometimes localization is not important
		</div>

		<div id="header1">12. Array insertion</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local a = {}
local tinsert = table.insert
local count = 1
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
tinsert(a, times)
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
tinsert(a, 1, times)
			</div>
			<div id="subh">Code 3:</div>
			<div id="code">
a[times] = times
			</div>
			<div id="subh">Code 4:</div>
			<div id="code">
a[#a + 1] = times
			</div>
			<div id="subh">Code 5:</div>
			<div id="code">
a[count] = times
count = count + 1
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. <a id="highlight">tinsert: 0.152 (Min: 0.096, Average: 0.11547) second(s) (1381.81%)</a><br>
			&nbsp;&nbsp;2. <a id="highlight">tinsert at index 1: 671.901 (Min: 568.809, Average: 585.91501) second(s) (6108190.909091%)</a><br>
			&nbsp;&nbsp;3. a[times]: 0.011 (Min: 0.007, Average: 0.00802) second(s) (100%)<br>
			&nbsp;&nbsp;4. a[#a + 1]: 0.133 (Min: 0.095, Average: 0.11289) second(s) (1209%)<br>
			&nbsp;&nbsp;5. <a id="highlight">a[count] & count++: 0.146 (Min: 0.069, Average: 0.10431) second(s) (1327.27%)</a>
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;Try to use the `i` from the for loop or a[#a + 1].
		</div>

		<div id="header1">13. Table with and without pre-allocated size</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Code 1:</div>
			<div id="code">
local a = {}
a[1] = 1
a[2] = 2
a[3] = 3
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local a = {true, true, true}
a[1] = 1
a[2] = 2
a[3] = 3
			</div>
			<div id="subh">Code 3:</div>
			<div id="code">
local a = {1, 2, 3}
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. <a id="highlight">Allocated on demand: 6.504 (Min: 4.881, Average: 5.47615) second(s) (650400%)</a><br>
			&nbsp;&nbsp;2. Pre-allocated with dummy values: 0.001 (Min: 0, Average: 0.00031) second(s) (100%)<br>
			&nbsp;&nbsp;3. Defined in constructor: 0.001 (Min: 0, Average: 0.00036) second(s) (100%)
			

			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;Pre-allocate table size for better performance. 
		</div>

		<div id="header1">14. Table initialization before or each time on insertion</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
T = {}
local CachedTable = {"abc","def","ghk"}
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
T[times] = CachedTable
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
T[times] = {"abc","def","ghk"}
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. Cached table for all insertion: 0.002 (Min: 0, Average: 0.00081) second(s) (100%)<br>
			&nbsp;&nbsp;2. <a id="highlight">Table constructor for each insertion: 6.072 (Min: 4.174, Average: 4.25071) second(s) (303600%)</a>
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;If you use the same table/userdata/function multiple times cache it and reuse every time. (For example Color object in Garry's Mod)
		</div>

		<div id="header1">15. String split (by character)</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local text = "Hello, this is an example text"
local gsubfunc = function(s) local x = s end
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
for k=1,#text do local x = text:sub(k,k) end
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
for k in string.gmatch(text,".") do local x = k end
			</div>
			<div id="subh">Code 3:</div>
			<div id="code">
string.gsub(text,".",gsubfunc)
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. sub(1,1): 0.034 (Min: 0.027, Average: 0.02901) second(s) (100%) (100%)<br>
			&nbsp;&nbsp;2. <a id="highlight">gmatch with ".": 82.181 (Min: 77.892, Average: 80.0187) second(s) (241708.82%)</a><br>
			&nbsp;&nbsp;3. <a id="highlight">gsub with "." and cached function: 186.598 (Min: 152.957, Average: 159.10795) second(s) (548817.64%)</a>

			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;string.sub is ok for char splitting. Patterns deal huge impact on performance.
		</div>

		<div id="header1">16. Empty string check</div> <!-- ---------------------------------------------------- -->
		<div id="text1">
			<div id="subh">Predefines:</div>
			<div id="code">
local s = ""
			</div>
			<div id="subh">Code 1:</div>
			<div id="code">
local y = #s == 0
			</div>
			<div id="subh">Code 2:</div>
			<div id="code">
local y = s == ""
			</div>
			<div id="subh">Results:</div>
			&nbsp;&nbsp;1. len == 0: 0.001 (Min: 0, Average: 0.00037) second(s) (100%)<br>
			&nbsp;&nbsp;2. str == "": 0.001 (Min: 0, Average: 0.00036) second(s) (100%)<br>
			<div id="subh">Conclusion:</div>
			&nbsp;&nbsp;No difference. Use the latter syntax if you don't know the value type.
		</div>

		<div id="bottom">
			<div style="text-align: center; font-size: 1.5em; padding-top: 2.5em">
			<img src="http://hits.dwyl.io/GitSparTV/LuaJIT-Benchmarks/index.html.svg"><br>
			Made by Spar (Spar#6665)<br>
			New benchmark tests are welcome. <a href="https://github.com/GitSparTV/LuaJIT-Benchmarks/">GitHub Page</a><br>
			Public Domain<br>
			2019
			</div>
		</div>
	</body>
</html>